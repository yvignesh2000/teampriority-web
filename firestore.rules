rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function getUserOrgId() {
      return getUserData().organizationId;
    }
    
    function isOrgMember(orgId) {
      return isAuthenticated() && getUserOrgId() == orgId;
    }
    
    function isOrgOwner(orgId) {
      return isAuthenticated() && getUserData().role == 'OWNER' && getUserOrgId() == orgId;
    }
    
    function isOrgAdmin(orgId) {
      return isAuthenticated() && (getUserData().role == 'ADMIN' || getUserData().role == 'OWNER') && getUserOrgId() == orgId;
    }
    
    // Organizations
    match /organizations/{orgId} {
      allow read: if isOrgMember(orgId);
      allow create: if isAuthenticated();
      allow update, delete: if isOrgOwner(orgId);
    }
    
    // Users - can read teammates, write own
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || 
        getUserOrgId() == resource.data.organizationId
      );
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if false;
    }
    
    // Tasks - org-scoped, owner/admin can write
    match /tasks/{taskId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if isAuthenticated() && isOrgMember(request.resource.data.organizationId);
      allow update, delete: if isAuthenticated() && isOrgMember(resource.data.organizationId) &&
        (resource.data.ownerId == request.auth.uid || isOrgAdmin(resource.data.organizationId));
    }
    
    // Topics - org-scoped, admin can write
    match /topics/{topicId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create, update, delete: if isOrgAdmin(request.resource.data.organizationId);
    }
    
    // Weekly Goals - org-scoped, owner writes own
    match /weeklyGoals/{goalId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if isAuthenticated() && isOrgMember(request.resource.data.organizationId) &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Goal Outcomes - org-scoped
    match /goalOutcomes/{outcomeId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if isAuthenticated() && isOrgMember(request.resource.data.organizationId) &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Top 3 Items - org-scoped
    match /top3Items/{itemId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if isAuthenticated() && isOrgMember(request.resource.data.organizationId) &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Proof Logs - org-scoped
    match /proofLogs/{logId} {
      allow read: if isOrgMember(resource.data.organizationId);
      allow create: if isAuthenticated() && isOrgMember(request.resource.data.organizationId) &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Weekly Summaries - org-scoped, private
    match /weeklySummaries/{summaryId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
  }
}
